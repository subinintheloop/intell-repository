<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGINT // AIRSPACE MONITOR</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #00ff88;
    --green-dim: #00ff8844;
    --green-dark: #00cc66;
    --red: #ff3355;
    --amber: #ffaa00;
    --bg: #030a06;
    --panel: #050f08;
    --border: #0a2a14;
    --text: #a0ffcc;
    --text-dim: #3a7a55;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* SCANLINE OVERLAY */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,255,100,0.015) 2px,
      rgba(0,255,100,0.015) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
    flex-shrink: 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    border: 2px solid var(--green);
    border-radius: 50%;
    position: relative;
    animation: radar-spin 4s linear infinite;
  }

  .logo-icon::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, var(--green), transparent);
    transform-origin: left center;
    transform: translateY(-50%);
    animation: radar-sweep 4s linear infinite;
  }

  @keyframes radar-sweep {
    from { transform: translateY(-50%) rotate(0deg); }
    to { transform: translateY(-50%) rotate(360deg); }
  }

  .logo-text {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 18px;
    letter-spacing: 4px;
    color: var(--green);
  }

  .logo-sub {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 2px;
  }

  .header-stats {
    display: flex;
    gap: 24px;
  }

  .stat {
    text-align: center;
  }

  .stat-val {
    font-family: 'Rajdhani', sans-serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--green);
    line-height: 1;
  }

  .stat-label {
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .pulse-dot.red { background: var(--red); animation: pulse-red 1s ease-in-out infinite; }
  .pulse-dot.amber { background: var(--amber); }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--green); }
    50% { opacity: 0.4; box-shadow: none; }
  }
  @keyframes pulse-red {
    0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--red); }
    50% { opacity: 0.3; box-shadow: none; }
  }

  /* MAIN LAYOUT */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* MAP */
  #map {
    flex: 1;
    background: #030a06;
    position: relative;
  }

  /* SIDE PANEL */
  .panel {
    width: 300px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .panel-section {
    border-bottom: 1px solid var(--border);
    padding: 12px;
  }

  .panel-title {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-dim);
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .panel-title span { color: var(--green); }

  /* PIZZA INDEX */
  .pizza-index {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    background: #0a1a0f;
    border: 1px solid var(--border);
    border-radius: 2px;
    margin-bottom: 8px;
  }

  .pizza-icon { font-size: 20px; }

  .pizza-label {
    font-size: 10px;
    color: var(--text-dim);
  }

  .pizza-val {
    font-family: 'Rajdhani', sans-serif;
    font-size: 18px;
    font-weight: 700;
  }

  .pizza-val.low { color: var(--green); }
  .pizza-val.med { color: var(--amber); }
  .pizza-val.high { color: var(--red); }

  .meter {
    height: 4px;
    background: #0a2a14;
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
  }

  .meter-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s ease;
  }

  .meter-fill.green { background: linear-gradient(90deg, var(--green-dark), var(--green)); }
  .meter-fill.amber { background: linear-gradient(90deg, #cc7700, var(--amber)); }
  .meter-fill.red { background: linear-gradient(90deg, #cc0022, var(--red)); }

  /* FLIGHT LIST */
  .flight-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .flight-list::-webkit-scrollbar { width: 4px; }
  .flight-list::-webkit-scrollbar-track { background: transparent; }
  .flight-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .flight-item {
    padding: 8px;
    border: 1px solid var(--border);
    margin-bottom: 6px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    background: #050f08;
  }

  .flight-item:hover, .flight-item.active {
    border-color: var(--green);
    background: #0a1a0f;
  }

  .flight-item.military {
    border-color: var(--red);
    background: #1a0508;
  }

  .flight-item.military:hover { border-color: #ff6680; }

  .flight-callsign {
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--green);
    display: flex;
    justify-content: space-between;
  }

  .flight-item.military .flight-callsign { color: var(--red); }

  .flight-detail {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 2px;
    display: flex;
    justify-content: space-between;
  }

  .tag {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 2px;
    letter-spacing: 1px;
  }

  .tag.mil { background: rgba(255,51,85,0.2); color: var(--red); border: 1px solid var(--red); }
  .tag.civil { background: rgba(0,255,136,0.1); color: var(--green-dark); border: 1px solid var(--border); }
  .tag.unknown { background: rgba(255,170,0,0.1); color: var(--amber); border: 1px solid var(--amber); }

  /* FOOTER */
  footer {
    padding: 6px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: var(--text-dim);
    background: var(--panel);
    flex-shrink: 0;
  }

  #clock { color: var(--green); font-size: 12px; letter-spacing: 2px; }
  #refresh-countdown { color: var(--amber); }

  /* LOADING */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(3,10,6,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: 'Share Tech Mono', monospace;
  }

  .loading-text {
    color: var(--green);
    font-size: 13px;
    letter-spacing: 3px;
    animation: blink 1s step-end infinite;
  }

  @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0; } }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 2px solid var(--border);
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* MAP CUSTOM STYLES */
  .flight-icon {
    font-size: 14px;
    line-height: 1;
    filter: drop-shadow(0 0 4px #00ff88);
    transition: transform 0.5s ease;
  }

  .flight-icon.military { filter: drop-shadow(0 0 5px #ff3355); }

  .leaflet-popup-content-wrapper {
    background: var(--panel) !important;
    border: 1px solid var(--green) !important;
    border-radius: 2px !important;
    box-shadow: 0 0 20px rgba(0,255,136,0.2) !important;
    color: var(--text) !important;
    font-family: 'Share Tech Mono', monospace !important;
  }

  .leaflet-popup-tip { background: var(--panel) !important; }
  .leaflet-popup-close-button { color: var(--green) !important; }

  .popup-title {
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--green);
    border-bottom: 1px solid var(--border);
    padding-bottom: 6px;
    margin-bottom: 8px;
  }

  .popup-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-dim);
    margin: 3px 0;
  }

  .popup-row span:last-child { color: var(--text); }

  /* No data message */
  .no-data {
    padding: 20px;
    text-align: center;
    color: var(--text-dim);
    font-size: 11px;
    letter-spacing: 1px;
  }

  /* ALERT BANNER */
  .alert-banner {
    display: none;
    background: rgba(255,51,85,0.15);
    border-bottom: 1px solid var(--red);
    padding: 6px 20px;
    font-size: 11px;
    color: var(--red);
    letter-spacing: 2px;
    text-align: center;
    animation: blink 0.5s step-end infinite;
    flex-shrink: 0;
  }

  .alert-banner.show { display: block; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div>
      <div class="logo-text">AIRSPACE MONITOR</div>
      <div class="logo-sub">IRAN / MIDDLE EAST REGION // OSINT FEED</div>
    </div>
  </div>

  <div class="header-stats">
    <div class="stat">
      <div class="stat-val" id="total-flights">--</div>
      <div class="stat-label">TRACKED</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="mil-count" style="color:var(--red)">--</div>
      <div class="stat-label">FLAGGED</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="region-count">--</div>
      <div class="stat-label">IN REGION</div>
    </div>
  </div>

  <div class="status-bar">
    <div class="pulse-dot" id="status-dot"></div>
    <span id="status-text">CONNECTING...</span>
  </div>
</header>

<div class="alert-banner" id="alert-banner">‚ö† ELEVATED FLIGHT ACTIVITY DETECTED IN MONITORED REGION ‚ö†</div>

<div class="main">
  <div id="map">
    <div class="loading-overlay" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">ACQUIRING SIGNAL...</div>
    </div>
  </div>

  <div class="panel">
    <!-- PIZZA INDEX -->
    <div class="panel-section">
      <div class="panel-title">PIZZA INDEX <span id="pizza-time">--:--</span></div>

      <div class="pizza-index">
        <div class="pizza-icon">üçï</div>
        <div style="flex:1">
          <div class="pizza-label">ACTIVITY LEVEL (PROXY)</div>
          <div class="pizza-val" id="pizza-val">CALCULATING...</div>
          <div class="meter">
            <div class="meter-fill green" id="pizza-meter" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div style="font-size:10px; color:var(--text-dim); line-height:1.5">
        Based on: flight density √ó altitude anomalies √ó speed deviations in monitored region.
      </div>
    </div>

    <!-- REGION FILTER -->
    <div class="panel-section">
      <div class="panel-title">MONITOR ZONE</div>
      <select id="region-select" style="
        background: #0a1a0f;
        color: var(--green);
        border: 1px solid var(--border);
        padding: 6px 8px;
        font-family: 'Share Tech Mono', monospace;
        font-size: 11px;
        width: 100%;
        cursor: pointer;
        letter-spacing: 1px;
      ">
        <option value="iran">IRAN (24-40¬∞N, 44-64¬∞E)</option>
        <option value="gulf">PERSIAN GULF (22-28¬∞N, 48-60¬∞E)</option>
        <option value="mideast">WIDER MIDDLE EAST (20-42¬∞N, 34-64¬∞E)</option>
      </select>
    </div>

    <!-- FLIGHT LIST -->
    <div class="panel-title" style="padding:12px 12px 0; margin-bottom:0">
      TRACKED FLIGHTS
      <span id="list-count">0</span>
    </div>
    <div class="flight-list" id="flight-list">
      <div class="no-data">AWAITING DATA...</div>
    </div>
  </div>
</div>

<footer>
  <div>SOURCE: OPENSKY NETWORK // ADS-B // OPEN DATA</div>
  <div id="clock">--:--:-- UTC</div>
  <div>REFRESH IN: <span id="refresh-countdown" style="color:var(--amber)">--</span>s</div>
</footer>

<script>
// =============================================
//  REGION DEFINITIONS
// =============================================
const REGIONS = {
  iran:    { minLat:24, maxLat:40, minLon:44, maxLon:64, center:[32,54], zoom:6 },
  gulf:    { minLat:22, maxLat:28, minLon:48, maxLon:60, center:[25,54], zoom:7 },
  mideast: { minLat:20, maxLat:42, minLon:34, maxLon:64, center:[32,48], zoom:5 }
};

let currentRegion = 'iran';
let flights = [];
let markers = {};
let selectedFlight = null;
let countdown = 30;
let countdownInterval;

// =============================================
//  MAP SETUP
// =============================================
const map = L.map('map', {
  center: REGIONS[currentRegion].center,
  zoom: REGIONS[currentRegion].zoom,
  zoomControl: true,
  attributionControl: true
});

// Dark military-style tile layer
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '¬© CartoDB ¬© OpenStreetMap',
  maxZoom: 18
}).addTo(map);

// Draw region box
let regionRect;
function drawRegionBox(regionKey) {
  const r = REGIONS[regionKey];
  if (regionRect) map.removeLayer(regionRect);
  regionRect = L.rectangle(
    [[r.minLat, r.minLon], [r.maxLat, r.maxLon]],
    { color: '#00ff88', weight: 1, opacity: 0.5, fillOpacity: 0.03, dashArray: '4' }
  ).addTo(map);
}
drawRegionBox(currentRegion);

// =============================================
//  FLIGHT ICON CREATION
// =============================================
function getFlightIcon(heading, isMilitary) {
  const rotation = heading || 0;
  const color = isMilitary ? '#ff3355' : '#00ff88';
  const glow = isMilitary ? '#ff3355' : '#00ff88';
  return L.divIcon({
    html: `<div style="
      transform: rotate(${rotation}deg);
      font-size: 16px;
      filter: drop-shadow(0 0 4px ${glow});
      color: ${color};
      line-height:1;
    ">‚úà</div>`,
    className: '',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
}

// =============================================
//  MILITARY/FLAGGED DETECTION
// =============================================
const MILITARY_PATTERNS = [
  /^(CNV|USAF|RCH|CASA|JAKE|MAGMA|ROCKY|LOBO|REACH|SPAR|POLO|GLEX|BISON|FURY|GHOST|BLADE)/i,
  /^[A-Z]{2}\d{4,}$/,  // generic pattern
];

const INTERESTING_CALLSIGNS = [
  'USAF', 'RCH', 'SPAR', 'CNV', 'REACH', 'JAKE', 'POLO', 'ROCKY',
  'MAGMA', 'GHOST', 'BLADE', 'FURY', 'RAGE', 'VIPER'
];

function isMilitary(callsign, icao) {
  if (!callsign) return false;
  const cs = callsign.trim().toUpperCase();
  return INTERESTING_CALLSIGNS.some(k => cs.startsWith(k));
}

function classifyFlight(callsign, icao) {
  if (isMilitary(callsign, icao)) return 'military';
  if (!callsign || callsign.trim() === '') return 'unknown';
  return 'civil';
}

// =============================================
//  FETCH FROM OPENSKY
// =============================================
async function fetchFlights() {
  const r = REGIONS[currentRegion];
  const url = `https://opensky-network.org/api/states/all?lamin=${r.minLat}&lomin=${r.minLon}&lamax=${r.maxLat}&lomax=${r.maxLon}`;

  try {
    document.getElementById('status-dot').className = 'pulse-dot amber';
    document.getElementById('status-text').textContent = 'FETCHING...';

    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('status-dot').className = 'pulse-dot';
    document.getElementById('status-text').textContent = 'LIVE FEED';

    processFlights(data.states || []);
  } catch(e) {
    document.getElementById('status-dot').className = 'pulse-dot red';
    document.getElementById('status-text').textContent = 'ERROR ‚Äî RETRY';
    document.getElementById('loading').style.display = 'none';
    console.error('Fetch error:', e);

    // Show error in panel
    document.getElementById('flight-list').innerHTML =
      `<div class="no-data">‚ö† FEED INTERRUPTED<br><br>OpenSky may be rate-limiting.<br>Wait 30s for retry.</div>`;
  }
}

// =============================================
//  PROCESS & RENDER FLIGHTS
// =============================================
function processFlights(states) {
  flights = states.map(s => ({
    icao:     s[0],
    callsign: (s[1] || '').trim(),
    country:  s[2],
    lat:      s[6],
    lon:      s[5],
    altitude: s[7],   // meters
    speed:    s[9],   // m/s
    heading:  s[10],
    vertical: s[11],  // m/s
    onGround: s[8],
    type:     classifyFlight(s[1], s[0])
  })).filter(f => f.lat && f.lon && !f.onGround);

  updateMap();
  updatePanel();
  updateStats();
  updatePizzaIndex();
}

function updateMap() {
  const currentIcaos = new Set(flights.map(f => f.icao));

  // Remove stale markers
  Object.keys(markers).forEach(icao => {
    if (!currentIcaos.has(icao)) {
      map.removeLayer(markers[icao]);
      delete markers[icao];
    }
  });

  // Add/update markers
  flights.forEach(f => {
    const icon = getFlightIcon(f.heading, f.type === 'military');
    const popup = `
      <div class="popup-title">${f.callsign || f.icao} <span class="tag ${f.type}">${f.type.toUpperCase()}</span></div>
      <div class="popup-row"><span>ICAO:</span><span>${f.icao.toUpperCase()}</span></div>
      <div class="popup-row"><span>COUNTRY:</span><span>${f.country || 'UNKNOWN'}</span></div>
      <div class="popup-row"><span>ALTITUDE:</span><span>${f.altitude ? Math.round(f.altitude)+'m / '+Math.round(f.altitude*3.281)+'ft' : '---'}</span></div>
      <div class="popup-row"><span>SPEED:</span><span>${f.speed ? Math.round(f.speed*1.944)+' kts' : '---'}</span></div>
      <div class="popup-row"><span>HEADING:</span><span>${f.heading ? Math.round(f.heading)+'¬∞' : '---'}</span></div>
      <div class="popup-row"><span>VERTICAL:</span><span>${f.vertical ? (f.vertical>0?'+':'')+Math.round(f.vertical*196.85)+' fpm' : '---'}</span></div>
      <div class="popup-row"><span>POSITION:</span><span>${f.lat.toFixed(3)}¬∞N ${f.lon.toFixed(3)}¬∞E</span></div>
    `;

    if (markers[f.icao]) {
      markers[f.icao].setLatLng([f.lat, f.lon]);
      markers[f.icao].setIcon(icon);
    } else {
      markers[f.icao] = L.marker([f.lat, f.lon], { icon })
        .addTo(map)
        .bindPopup(popup, { maxWidth: 260 });
    }
  });
}

function updatePanel() {
  const list = document.getElementById('flight-list');
  document.getElementById('list-count').textContent = flights.length;

  if (flights.length === 0) {
    list.innerHTML = '<div class="no-data">NO FLIGHTS IN REGION<br><br>Airspace clear or data delayed.</div>';
    return;
  }

  // Sort: military first, then by altitude desc
  const sorted = [...flights].sort((a,b) => {
    if (a.type === 'military' && b.type !== 'military') return -1;
    if (b.type === 'military' && a.type !== 'military') return 1;
    return (b.altitude||0) - (a.altitude||0);
  });

  list.innerHTML = sorted.map(f => `
    <div class="flight-item ${f.type === 'military' ? 'military' : ''} ${selectedFlight === f.icao ? 'active' : ''}"
         onclick="selectFlight('${f.icao}', ${f.lat}, ${f.lon})">
      <div class="flight-callsign">
        ${f.callsign || f.icao.toUpperCase()}
        <span class="tag ${f.type}">${f.type === 'unknown' ? 'UNK' : f.type.toUpperCase().slice(0,3)}</span>
      </div>
      <div class="flight-detail">
        <span>${f.altitude ? Math.round(f.altitude*3.281)+'ft' : '---'}</span>
        <span>${f.speed ? Math.round(f.speed*1.944)+'kts' : '---'}</span>
        <span>${f.country || '???'}</span>
      </div>
    </div>
  `).join('');
}

function selectFlight(icao, lat, lon) {
  selectedFlight = icao;
  map.setView([lat, lon], 8, { animate: true });
  if (markers[icao]) markers[icao].openPopup();
  updatePanel();
}

function updateStats() {
  const milCount = flights.filter(f => f.type === 'military').length;
  document.getElementById('total-flights').textContent = flights.length;
  document.getElementById('mil-count').textContent = milCount;
  document.getElementById('region-count').textContent = flights.length;

  // Alert banner if many military
  const banner = document.getElementById('alert-banner');
  if (milCount >= 3) {
    banner.classList.add('show');
  } else {
    banner.classList.remove('show');
  }
}

function updatePizzaIndex() {
  // Pizza Index: synthetic metric based on flight density + military ratio
  const total = flights.length;
  if (total === 0) {
    document.getElementById('pizza-val').textContent = 'NO DATA';
    document.getElementById('pizza-meter').style.width = '0%';
    return;
  }

  const milRatio = flights.filter(f => f.type === 'military').length / total;
  const avgAlt = flights.reduce((s,f) => s + (f.altitude||0), 0) / total;
  const lowAlt = flights.filter(f => f.altitude && f.altitude < 3000).length;

  // Score: 0-100
  let score = Math.min(100, Math.round(
    (total * 0.5) +
    (milRatio * 40) +
    (lowAlt * 5)
  ));

  let label, cls, meterCls;
  if (score < 25)       { label = 'LOW';      cls = 'low';  meterCls = 'green'; }
  else if (score < 60)  { label = 'ELEVATED'; cls = 'med';  meterCls = 'amber'; }
  else                  { label = 'HIGH';      cls = 'high'; meterCls = 'red'; }

  const valEl = document.getElementById('pizza-val');
  const meterEl = document.getElementById('pizza-meter');

  valEl.textContent = `${label} (${score}/100)`;
  valEl.className = `pizza-val ${cls}`;
  meterEl.className = `meter-fill ${meterCls}`;
  meterEl.style.width = `${score}%`;

  const now = new Date();
  document.getElementById('pizza-time').textContent =
    now.getUTCHours().toString().padStart(2,'0') + ':' +
    now.getUTCMinutes().toString().padStart(2,'0') + 'Z';
}

// =============================================
//  CLOCK & COUNTDOWN
// =============================================
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.getUTCHours().toString().padStart(2,'0') + ':' +
    now.getUTCMinutes().toString().padStart(2,'0') + ':' +
    now.getUTCSeconds().toString().padStart(2,'0') + ' UTC';
}

function startCountdown() {
  clearInterval(countdownInterval);
  countdown = 30;
  document.getElementById('refresh-countdown').textContent = countdown;
  countdownInterval = setInterval(() => {
    countdown--;
    document.getElementById('refresh-countdown').textContent = countdown;
    if (countdown <= 0) {
      fetchFlights();
      countdown = 30;
    }
  }, 1000);
}

// =============================================
//  REGION SELECTOR
// =============================================
document.getElementById('region-select').addEventListener('change', function() {
  currentRegion = this.value;
  const r = REGIONS[currentRegion];
  map.setView(r.center, r.zoom, { animate: true });
  drawRegionBox(currentRegion);

  // Clear markers
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};

  document.getElementById('loading').style.display = 'flex';
  fetchFlights();
});

// =============================================
//  INIT
// =============================================
setInterval(updateClock, 1000);
updateClock();
fetchFlights();
startCountdown();

// Refetch and restart countdown every 30s
setInterval(() => {
  fetchFlights();
  startCountdown();
}, 30000);
</script>
</body>
</html>
